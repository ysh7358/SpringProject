<!--황지수-->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>보육원 상세페이지</title>
    <link rel="stylesheet" type="text/css"
          href="//p25.zdassets.com/hc/theming_assets/9204604/360002309011/style.css?digest=12256508972825">
</head>
<!-- ======================================헤더/푸터======================================== -->

<link href="/css/school/schoolDetail.css" rel="stylesheet"/>
<link href="/css/school/calendar.css" rel="stylesheet"/>

<link rel="stylesheet" href="/css/fix/header.css">
<link rel="stylesheet" href="/css/fix/footer.css">
<link rel="icon" href="/imgs/fix/favicon.png">

<!-- ================================================================================================================ -->

<body>
<header th:replace="/fix/header.html :: header"></header>

<div class="wholePage">

    <section class="wholeSection">
        <main>
            <section id="category">
                <div class="bigCategory">
                    보육원
                </div>
                <span role="img" color="#555969" rotate="0" class="css-46ifd7 e181xm9y1"
                      style="display: flex;align-items: center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"
                         focusable="false" preserveAspectRatio="xMidYMid meet" class="css-7kp13n e181xm9y0">
                        <path xmlns="http://www.w3.org/2000/svg"
                              d="M9.41421356,12 L15.7071068,5.70710678 C16.0976311,5.31658249 16.0976311,4.68341751 15.7071068,4.29289322 C15.3165825,3.90236893 14.6834175,3.90236893 14.2928932,4.29289322 L7.29289322,11.2928932 C6.90236893,11.6834175 6.90236893,12.3165825 7.29289322,12.7071068 L14.2928932,19.7071068 C14.6834175,20.0976311 15.3165825,20.0976311 15.7071068,19.7071068 C16.0976311,19.3165825 16.0976311,18.6834175 15.7071068,18.2928932 L9.41421356,12 Z"
                              transform="translate(11.500000, 12.000000) scale(-1, 1) translate(-11.500000, -12.000000) ">
                        </path>
                    </svg>
                </span>

                <div class="smallCategory location"></div>
            </section>

            <!-- 이미지 -->
            <section id="imgsSection" th:object="${schoolDTO}">
                <!-- 메인이미지 -->
                <div class="mainImage">
                    <img id="mainImage" src="/imgs/school/defaultSchoolImg.png">
                </div>
                <!-- 작은 이미지들 보이는 div 1-->
                <div id="list">
                    <!-- 작은 이미지들 보이는 div 2-->
                    <div class="images">
                        <!-- 긴 div -->
                        <div class="longImages">
                            <!-- 작은 이미지들 -->
                            <div class="miniImages">
                                <!-- 작은 이미지 하나 -->
                                <div class="miniImage">
                                    <img class="one"
                                         src="/imgs/school/defaultSchoolImg.png">
                                </div>
                                <div class="miniImage">
                                    <img class="one"
                                         src="/imgs/school/defaultSchoolImg.png">
                                </div>
                                <div class="miniImage">
                                    <img class="one"
                                         src="/imgs/school/defaultSchoolImg.png">
                                </div>
                                <div class="miniImage">
                                    <img class="one"
                                         src="/imgs/school/defaultSchoolImg.png">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <nav id="commentNavi">
                <div id="naviBar">
                    <div class="navText">댓글</div>
                </div>
            </nav>

            <section>
                <div id="comments">
                    <div>댓글<span id="commentsCount"></span>개</div>
                </div>

                <!-- 댓글리스트 -->
                <div class="commentsList">
                </div>

                <div class="more">
                    <button color="default" class="moreButton">
                        <span class="css-1oteowz eklkj751" id="moreReply">더 보기</span>
                    </button>
                </div>

                <!--============= 등록============== -->
                <div class="comment display-none" id="noBorderBottom" style="border-bottom: transparent;">
                    <div class="commentsInfo">
                        <div class="profilePicture">
                            <img class = "replyProfile" src="/imgs/myPage/normalProfile.png">
                        </div>
                        <div class="nameAndDate">
                            <div class="nickName">해피123</div>
                        </div>
                    </div>
                    <div class="commentContent">
                        <div class="commentContent2">
                            <textarea name="" class="reply" cols="30" placeholder="댓글을 남겨보세요" rows="3"></textarea>
                        </div>
                        <input type="button" class="replyRegisterButton" value="등록">
                    </div>
                </div>

            </section>

        </main>

        <!-- 우측 어사이드 바 -->
        <aside>
            <!-- 찜하기 -->
            <section id="zzim">
                <button class="zzimButton">
                    <!-- 빈 하트 -->
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"
                         focusable="false" preserveAspectRatio="xMidYMid meet" class="emptyHeart">
                        <path xmlns="http://www.w3.org/2000/svg"
                              d="M16.3680447,3 C14.8701244,3 13.434867,3.60809471 12.3788995,4.68835248 L11.999764,5.07602721 L11.6205012,4.68822239 C9.41974855,2.43790277 5.843218,2.4379028 3.64246538,4.68822244 C1.45251156,6.92750008 1.45251154,10.5501072 3.64246532,12.7893849 L11.4435969,20.7662195 C11.7484384,21.0779268 12.2510896,21.0779268 12.555931,20.7662195 L20.3570626,12.7893849 C21.4096395,11.7136062 22,10.2567327 22,8.73880364 C22,7.22093571 21.409687,5.76411845 20.3570626,4.68822238 C19.3011071,3.60804588 17.8659048,3 16.3680447,3 Z M11.999764,19.1166999 L4.75479942,11.7085588 C3.15293092,10.0706117 3.15293094,7.4069956 4.75479947,5.76904857 C6.34586921,4.14214354 8.91709737,4.14214352 10.5081671,5.76904852 L11.4435969,6.72554678 C11.7484384,7.0372541 12.2510896,7.0372541 12.555931,6.72554678 L13.4913608,5.76904851 C14.2561214,4.98669624 15.2906419,4.5483871 16.3680447,4.5483871 C17.4454474,4.5483871 18.4799679,4.98669624 19.2446013,5.76891842 C20.0136074,6.55487573 20.4466019,7.6234063 20.4466019,8.73880364 C20.4466019,9.85420097 20.0136074,10.9227315 19.2448557,11.7084287 L18.3092987,12.665057 L11.999764,19.1166999 Z">
                        </path>
                    </svg>
                    <!-- 빨간 하트 -->
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="#ff7262" aria-hidden="true"
                         focusable="false" preserveAspectRatio="xMidYMid meet" class="redHeart">
                        <path xmlns="http://www.w3.org/2000/svg"
                              d="M16.3680447,3 C14.8701244,3 13.434867,3.60809471 12.3788995,4.68835248 L11.999764,5.07602721 L11.6205012,4.68822239 C9.41974855,2.43790277 5.843218,2.4379028 3.64246538,4.68822244 C1.45251156,6.92750008 1.45251154,10.5501072 3.64246532,12.7893849 L11.4435969,20.7662195 C11.7484384,21.0779268 12.2510896,21.0779268 12.555931,20.7662195 L20.3570626,12.7893849 C21.4096395,11.7136062 22,10.2567327 22,8.73880364 C22,7.22093571 21.409687,5.76411845 20.3570626,4.68822238 C19.3011071,3.60804588 17.8659048,3 16.3680447,3 Z">
                        </path>
                    </svg>
                    <span id="zzimCount">10</span>
                </button>
                </span>
            </section>
            <!-- 보육원 이름 -->
            <input type="hidden" class="userId" th:value="${userId}">
            <section class="schoolName">
                <h1></h1>
            </section>
            <!-- 소개, 기부받은 금액, 랭킹 -->
            <section class="introTotalRanking">
                <div class="introTotalRanking2">
                    <div class="intro introTotalRanking3" id="intro">INTRO</div>
                    <div class="total introTotalRanking3">TOTAL</div>
                    <div class="ranking introTotalRanking3">RANKING</div>
                    <div id="pseudo"></div>
                </div>

                <div class="rightBox1">
                    <!-- INTRO 박스 -->
                    <div class="rightBox2" id="introRightBox">
                        <span class="introTitle schoolTitle"></span>
                        <!-- 보육원 정보 -->
                        <div class="schoolInfo">
                            <div class="address">주소 : <span class="addressIn"></span>
                            </div>
                            <div class="phone">전화 : <span class="phoneIn"></span></div>
                            <div class="childCount">아이들 인원 : <span class="childCountIn"></span>명</div>
                        </div>

                        <div class="introContent">
                        </div>
                    </div>
                    <!-- TOTAL 박스 -->
                    <div class="rightBox2" id="totalRightBox">
                        <span class="introTitle totalTitle">최근기부</span>
                        <div class="totalBox">
                            <div class="noneDonation">
                                <div>
                                    기부 받은 내역이 없습니다.
                                </div>
                            </div>
                            <!-- 기부 내역 -->
                            <table id="userTable">
                            </table>
                        </div>
                    </div>
                    <!-- RANKING 박스 -->
                    <div class="rightBox2" id="rankingRightBox">
                        <span class="introTitle rankingTitle">기부랭킹</span>
                        <div class="rankingBox">
                            <div class="noneDonation">
                                <div>
                                    기부 받은 내역이 없습니다.
                                    첫 후원자가 되어보세요.
                                </div>
                            </div>

                            <table id="userTable2">
                                <thead id="rankingTHead" style="border-top:1px solid gray">
                                <th class="thth"></th>
                                <th class="thth">닉네임</th>
                                <th class="thth">기부금</th>
                                </thead>
                                <!-- 유저 한명 -->
                                <tbody>
                                <tr class="oneUser">
                                    <!-- 순위 -->
                                    <th></th>
                                    <!-- 닉네임 -->
                                    <th class="userTr userNickname"></th>
                                    <!-- 금액 -->
                                    <th class="userTr donation"><span class="amount"></span>원</th>
                                </tr>
                                </tbody>
                            </table>

                        </div>
                    </div>
                    <div class="display-none donationWrap">
                        <div class="donateDIV">
                            <button class="donate" id="donateMoney">
                                <span>기부하기</span>
                            </button>
                        </div>
                        <a href="#none" onclick="openModal()">
                            <div class="QRgo">
                                <button class="QRButton">
                                    <span>QR 보러가기</span>
                                </button>
                            </div>
                        </a>
                    </div>
                </div>
            </section>

            <!-- 일정관리 섹션 -->
            <section class="calendar">
                <div class="calendarTitle">
                    <div class="calendarTitle2">
                        <h1 style="font-size: 18px; font-weight: bold;">보육원 일정</h1>
                    </div>
                </div>
                <div class="calendarContent">
                    <!-- 예약 가능한 날짜는 검정색 글씨 -->
                    <div class="calendarContent3">
                        <img src="https://d2v80xjmx68n4w.cloudfront.net/assets/icon/ic_escro.png" alt="">
                        <h5>지난 날짜는 선택하실수 없습니다.</h5>
                    </div>
                    <!-- 달력 -->
                    <div class="calendarContent2">
                        <div>
                            <div class="tempDiv">
                                <div class="callenderWrap">
                                    <div class="callenderHead">
                                        <div class="prevMonth"></div>
                                        <div class="nowMonth"></div>
                                        <div class="nextMonth"></div>
                                    </div>
                                    <table class="callenderBody" style="margin-bottom: 24px">
                                        <tr>
                                            <th>일</th>
                                            <th>월</th>
                                            <th>화</th>
                                            <th>수</th>
                                            <th>목</th>
                                            <th>금</th>
                                            <th>토</th>
                                        </tr>
                                    </table>
                                </div>
                                <button class="donate display-none" id="donateVisit">
                                    <span>신청하기</span>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </section>

        </aside>

    </section>

</div>

<!-- QR모달창 -->
<div id="modal" style="box-shadow: rgb(0 0 0 / 50%) 0px 0px 0px 9999px">
    <!-- X버튼 -->
    <div class="sect01" onclick="closeModal()">
        <div class="line-box">
            <span class="line-01"></span>
            <span class="line-02"></span>
        </div>
    </div>
    <!-- QR 코드 -->
    <div id="modalQR">
        <img src="">
    </div>
    <div id="scanPlz">QR코드를 스캔하세요!</div>
</div>

<footer th:replace="/fix/footer.html :: footer"></footer>
</body>
<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<script src="/js/school/schoolDetail.js"></script>
<script src="/js/school/calendar.js"></script>
<script src="/js/fix/header.js"></script>
<script th:inline="javascript">
    let nowPage = 0;
    let schoolDTO = [[${schoolDTO}]]
    let userDTO = [[${userDTO}]]
    let sessionType = [[${session.type}]]
    let sessionId = [[${session.userId}]];
    let schoolId = $('.userId').val();

    // 보육원 회원 또는 비회원시 기부하기를 제한
    // 댓글등록쪽에 값을 각 회원에 맞게 수정
    if (sessionId) {
        $('.display-none').show();
    }
    if (sessionType == "people") {
        $(".nickName").text(userDTO.peopleNickname);
    }
    if (sessionType == "school") {
        $(".nickName").text(userDTO.schoolName);
        $('.donationWrap').hide();
        $('#donateVisit').hide();

    }
    // 댓글등록쪽에 각 회원이 등록한 프로필 사진을 띄움
    if(userDTO.file){
        $('.replyProfile').attr("src", `/file/display?fileName=` + userDTO.file.filePath + `/` + userDTO.file.fileUuid + `_` + userDTO.file.fileName)
    }

    // 보육원회원이 등록한 최대 5장의 사진을 화면에 보여줌
    showSchoolImg();

    //보육원 이미지추가와 모달이미지 추가
    function showSchoolImg() {
        let count = 0;
        schoolDTO.files.forEach(file => {
            if (!count) {
                $('#mainImage').attr("src", `/file/display?fileName=` + file.filePath + `/` + file.fileUuid + `_` + file.fileName)
            } else {
                $('.one').eq(count-1).attr("src", `/file/display?fileName=` + file.filePath + `/` + file.fileUuid + `_` + file.fileName)
            }
            count++;
        })
        $('#modalQR').children().attr("src",schoolDTO.schoolQR);
    }

    // 보육원에 대한 정보, 랭킹, 최근기부, 좋아요 개수, 댓글을 화면에 보여줌
    show();

    //보육원 정보
    function getInfo(schoolDTO) {
        $('.schoolName').find('h1').html(schoolDTO.schoolName);
        $('.smallCategory').html(schoolDTO.schoolAddress.substring(0, 2));
        $('.schoolTitle').html(schoolDTO.schoolTitle);
        $('.addressIn').html(schoolDTO.schoolAddress);
        if (schoolDTO.schoolPhoneNumber) {
            $('.phoneIn').html(schoolDTO.schoolPhoneNumber)
        } else {
            $('.phoneIn').html(schoolDTO.userPhoneNumber)
        }
        $('.childCountIn').html(schoolDTO.schoolKids);
        $('.introContent').html(schoolDTO.schoolContent);
    }

    //보육원 하나에 대한 최근 기부
    function getRecent(recentDonations) {
        let text = "";
        let count = 0;
        //최근 기부 유무
        if (recentDonations.length == 0) {
            $('#userTable').hide();
            $('#userTable2').hide();
            $('.noneDonation').show();
        } else {
            $('#userTable').show();
            $('#userTable2').show();
            $('.noneDonation').hide();
        }
        //
        recentDonations.forEach(school => {
            if (count == 6) return;
            count++;
            text += `<tr">`
            // <!-- 프로필 사진 -->
            text += `<th class="userTr userProfile">`
            text += `<div class="profilePicture">`
            if(school.file){
                text += `<img src="/file/display?fileName=`+ school.file.filePath + `/` + school.file.fileUuid + `_` + school.file.fileName +`">`
            }else {
                text += `<img src="/imgs/myPage/normalProfile.png">`
            }
            text += `</div>`
            text += `</th>`
            text += `<th class="userTr userNickname">` + school.peopleNickname + `</th>`
            text += `<th class="userTr donation"><span>` + school.moneyCash.toLocaleString('ko-KR') + `</span>원</th>`
            text += `</tr>`
        })
        $('#userTable').html(text);
    }

    //보육원 하나에 대한 기부 랭킹
    function getRanking(donationRanking) {
        let text = "";
        let count = 0;
        donationRanking.forEach(school => {
            if (count == 5) return;
            count++;
            text += `<tr class="oneUser">`
            text += `<th>` + count + `</th>`
            text += `<th class="userTr userNickname">` + school.peopleNickname + `</th>`
            text += `<th class="userTr donation"><span class="amount">` + school.moneyCash.toLocaleString('ko-KR') + `</span>원</th>`
            text += `</tr>`
        })
        $('#userTable2>tbody').html(text);
    }

    //=======================좋아요======================
    //내가 좋아한 보육원
    function clickLikeBtn(likeSchoolList) {
        likeSchoolList.forEach(id => {
            if (id == schoolId) {
                $(".redHeart").css({"display": "inline"})
                $(".emptyHeart").css({"display": "none"})
                check2 = true;
            }
        });
    }

    //좋아요 개수
    function likeCount(likeCount) {
        $('#zzimCount').html(likeCount);
    }

    //==========================댓글=============================
    let replyText = "";
    let lastReplyFlag;

    //DB를 조회해 나온 댓글을 화면에 쏴줌
    function getReply(replys) {
        replyText = "";
        lastReplyFlag = replys.last;
        $('.reply').val("");
        if (replys.content.length < replys.totalElements) {
            $('.more').show();
        } else {
            $('.more').hide();
        }

        replys.content.forEach(reply => {
            replyText += `<div class="comment">`
            replyText += `<div class="commentsInfo">`
            replyText += `<div class="profilePicture">`
            if(reply.file){
                replyText += `<img src="/file/display?fileName=`+ reply.file.filePath + `/` + reply.file.fileUuid + `_` + reply.file.fileName +`">`
            }else {
                replyText += `<img src="/imgs/myPage/normalProfile.png">`
            }
            replyText += `</div>`
            replyText += `<div class="nameAndDate">`
            if(reply.peopleNickName){
                replyText += `<div class="nickName">` + reply.peopleNickName + `</div>`
            }
            if(reply.schoolName){
                replyText += `<div class="nickName">` + reply.schoolName + `</div>`
            }
            replyText += `<div class="regDate">` + timeForToday(reply.createdDate) + `</div>`
            replyText += `</div>`
            replyText += `<input type = "hidden" class = "replyId" value ="` + reply.replyId + `">`
            if (reply.userId == sessionId) {
                replyText += `<div class="modifyAndDelete">`
                replyText += `<span class="mAd modifyReady">수정</span>`
                replyText += `<span class="between">&nbsp;&nbsp;|&nbsp;&nbsp;</span>`
                replyText += `<span class="mAd deleteReady">삭제</span>`
                replyText += `<span class="cancel">취소</span>`
                replyText += `</div>`
            }
            replyText += `</div>`
            replyText += `<div class="commentContent modifyShow">`
            replyText += `<div class="commentContent2">`
            replyText += `<p class="commentContent3">` + reply.replyContent + `</p>`
            replyText += `</div>`
            replyText += `</div>`
            replyText += `<div class="commentContent modifyHide">`
            replyText += `<div class="commentContent2">`
            replyText += `<textarea name="" class="reply" cols="30" rows="3">` + reply.replyContent + `</textarea>`
            replyText += `<input type="button" class="replyUpdateButton" value="수정">`
            replyText += `</div>`
            replyText += `</div>`
            replyText += `</div>`
        })
        $('.commentsList').html(replyText);
        $('#commentsCount').html(replys.totalElements)
    }

    // 댓글 수정
    $('.commentsList').on('click', ".modifyReady", function () {
        $(this).closest(".modifyAndDelete").closest(".commentsInfo").siblings(".modifyShow").hide();
        $(this).closest(".modifyAndDelete").closest(".commentsInfo").siblings(".modifyHide").show();

        $(this).css('display', 'none');
        $(this).siblings(".deleteReady").css('display', 'none');
        $(this).siblings(".between").css('display', 'none');
        /* 취소버튼 */
        $(this).siblings(".cancel").css('display', 'inline');
    })

    // 댓글 수정 취소
    $('.commentsList').on('click', ".cancel", function () {
        $(this).closest(".modifyAndDelete").closest(".commentsInfo").siblings(".modifyShow").show();
        $(this).closest(".modifyAndDelete").closest(".commentsInfo").siblings(".modifyHide").hide();

        $(this).css('display', 'none');
        $(this).siblings(".modifyReady").css('display', 'inline');
        $(this).siblings(".between").css('display', 'inline');
        $(this).siblings(".deleteReady").css('display', 'inline');
    })

    // 댓글 삭제
    $('.commentsList').on('click', ".deleteReady", function () {
        let replyId = $(this).parent().prev().val();
        nowPage = 0;
        remove(replyId, showReply)
    })

    // 댓글 수정
    $('.commentsList').on('click', ".replyUpdateButton", function () {
        let replyContent = $(this).prev().val();
        modify({
            replyContent: replyContent,
            replyId: $(this).closest('.comment').find('.replyId').val()
        }, showReply)
    })

    // 댓글 등록 버튼 활성화
    $('.reply').on('keyup', function () {
        if ($(this).val().length != 0) {
            $('.replyRegisterButton').css("background-color", "rgb(255, 212, 0)")
            $('.replyRegisterButton').css("color", "#303441")
        } else {
            $('.replyRegisterButton').css("background-color", "#fff")
            $('.replyRegisterButton').css("color", "#b7b7b7")
        }
    })

    // 댓글 등록
    $('.replyRegisterButton').on('click', function () {
        let replyContent = $(this).prev().children('textarea').val();
        if (!replyContent) {
            alert("댓글 내용을 입력하지 않았습니다.")
            return;
        }
        nowPage = 0;
        register({
            replyContent: replyContent,
            schoolUserId: schoolId,
        }, showReply)
        $(this).prev().val("");
        window.scrollTo({top: 0})
    })

    //댓글 보기
    function showReply() {
        getReply1({
            page: nowPage,
            userId: schoolId
        }, getReply)
    }

    //    ======================방문기부====================
    //방문기부 신청
    $('#donateVisit').on('click', function () {
        if (!saveDate) {
            alert("방문하실 날짜를 선택해 주세요.")
            return;
        }
        console.log(saveDate)
        serviceVisitDate({
            userId: schoolId,
            serviceVisitDate: saveDate
        })
    })

    //  ======================페이지 이동 후 정보 뿌림=================
    //show!!
    function show() {
        // 보육원에 대한 기부랭킹
        getRanking1({
            userId: schoolId
        }, getRanking)
        // 보육원에 대한 최근기부
        getRecent1({
            userId: schoolId
        }, getRecent);
        // 보육원 정보
        getInfo1({
            userId: schoolId
        }, getInfo);
        // 보육원에 달린 댓글
        showReply();
        // 보육원 좋아요 수
        showLikeCount();
        // 로그인한 회원이 좋아요한 보육원인지를 확인후 빈하트를 채움
        getLikeSchoolList(clickLikeBtn);
    }

    // 좋아요 수를 체크
    function showLikeCount(){
        getLikeCount(schoolId, likeCount);
    }
</script>
</html>